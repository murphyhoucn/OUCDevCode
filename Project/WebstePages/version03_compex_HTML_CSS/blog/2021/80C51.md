# 特点

```markdown
- 8位微处理器
- 物理结构上具有两个寻址空间:寻址64KB程序空间，寻址64KB数据空间
- 分类:
	无片内ROM型：80C31 必须代价EPROM才能使用
	带片内ROM型
		片内EPROM型：87C51
		片内FLASH型：89C51
		片内掩膜ROM型：80C51
		片内一次性编程（OTP）ROM：97C51
- 存储器配置：程序存储器和数据存储器分离，使用不同的指令和寻址方式进行访问
	寻址64KB程序空间，寻址64KB数据空间
- 80C51共有111条指令
- 80C51有分为2个中断优先级的5个中断源
- 内部RAM
	4个通用工作寄存区
	32个通用寄存器
	1个位寻址区
- 4个并行IO口（P0-P3）
	P0 P2可作为片外扩展地址总线使用
- 内部集成一个全双工的异步串口接口，可同时发送和接收数据

------------------------------------------------
补充：
单片机按存储结构可分为二类：一类是哈佛结构，另一类是普林斯顿结构。
       ①哈佛结构
       所谓哈佛结构是指程序存储器地址空间与数据存储器地址空间分开的单片机结构，如80C51单片机采用哈佛结构，所以80C51单片机的程序存储器地址空间与数据存储器地址空间是分开的，各有64K存储空间。
       ②普林斯顿结构
       所谓普林斯顿结构是指程序存储器地址空间与数据存储器地址空间合并的单片机结构，如MCS-96单片机采用普林斯顿结构，所以MCS-96单片机的程序存储器地址空间与数据存储器地址空间是合并的，共有64K存储空间。
```

# 结构

## 基本结构

![基本结构](80C51.assets/QQ图片20210626102242.png)

![QQ图片20210626115702](80C51.assets/QQ图片20210626115702.jpg)

``` markdown
- 80C51中没有单独的地址总线和数据总线，而是与通用并行口中的P0和P2口公用；
	8位数据线，16位地址线
        P0口分时作为低八位地址线和8为数据线用；
        P2口作为高八位地址线
    单片机在进行外部扩展时的地址线和数据线都不是独立的总线，而是与并行口IO共用
    来自网络：
    	8051单片机CPU是几位的?  
    	—— 8位,多少位机一般以数据总线的位数来确定的,8051的数据总线为P0口,8位分别为P0.0~P0.7,有16根地址总线,分别为P0和P2.
    
```

## 内部结构



![内部结构2](80C51.assets/QQ图片20210626103507.jpg)

![内部结构1](80C51.assets/QQ图片20210626103208.png)

``` markdown
（来自网络）
若除去图中的存储器电路和I/O部件，剩下的便是CPU。它可以分为运算器和控制器两部分。
	运算器功能部件包括算术逻辑运算单元ALU、累加器ACC、寄存器B、暂存寄存器TMP1、TMP2、程序状态字寄存器PSW等。
	控制器功能部件包括 **程序计数器PC** 、指令寄存器IR、指令译码器ID、定时控制逻辑电路CU、**数据指针寄存器DPTR** 、**堆栈指针SP** 及时钟电路等。

（1）运算器
    ①算术逻辑运算单元ALU（Arithmetic Logical Unit）
    ALU可以进行算术、逻辑运算。算术运算有：加、减、乘、除，逻辑运算有：与、或、异或等。
    ②累加器ACC
    累加器ACC的主要功能是在运算前存放一个操作数，运算后存放一个操作结果。80C51系列单片机虽然在结构上仍然以累加器A作为重要部件。但由于内部电路采取了措施，使得累加器A在数据传送、逻辑操作等方面的核心作用有所削弱。数据可以在片内直接/间接地址的存储器之间直接传送，而不必经过累加器A。但，加、减、乘、除算术运算指令的运算结果都存放在累加器A或AB寄存器对中。
    ③暂存器TMP1、TMP2
    由80C51单片机的内部结构框图可知，ALU进行算术逻辑运算前的两个操作数来自暂存器TMP1、TMP2，所以暂存器TMP1、TMP2用于存放运算前的两个操作数。
    ④程序状态字寄存器PSW
    程序状态字寄存器PSW用来存放运算结果的状态标志。PSW寄存器各位的含义如下，其中PSW.1未定义，其它各位说明如下：
        CY：进位标志。它是累加器A的进位位，如果操作结果在最高位有进位（加法）或借位（减法）时置1，否则清0。
        AC：半进位标志。它是低半字节的进位位（累加器A中A3位向A4位的进位），主要用于BCD码调整。低4位有进位（加法时）或向高4位有借位时（减法时），AC是1，否则，AC清0。
        F0：用户定义的状态标志位。可通过软件对它置位、复位或测试，以控制程序的流向。
        RS1、RS0：工作寄存器区选择控制位，用于选择4组工作寄存器之一。可以用软件来置位或清零，以确定工作寄存器区。RS1、RS0与寄存器区的对应关系如下：
        RS1、RS0=00——0区（地址00H~07H）
        RS1、RS0=01——1区（地址08H~0FH）
        RS1、RS0=10——2区（地址10H~17H）
        RS1、RS0=11——3区（地址18H~1FH）
        OV：溢出标志位，用于表示有符号数算术运算的溢出。溢出时OV为1，否则OV为0。
        P：奇偶标志位。每个指令周期都由硬件来置位或清零，以表示累加器A中1的个数的奇偶性。若1的个数为奇数，则P置位；若1的个数为偶数，则清零。
    ⑤寄存器B
    在乘除指令中，用到了寄存器B。
（2）控制器
控制器是控制单片机各种操作的部件，用于完成指令规定的操作。它包括程序计数器PC、指令寄存器IR、指令译码器ID、定时控制逻辑、数据指针寄存器DPTR、时钟发生器、复位电路、堆栈指针SP等。
	①程序计数器 PC
    程序计数器PC为16位寄存器，用于存放下一条要执行指令地址，具有自动加1功能。
    ②指令寄存器IR、指令译码器ID、定时控制逻辑电路
    指令寄存器IR用来暂时存放当前取出的指令，并由指令译码器ID译码，产生相应的译码信号，并传送给定时控制电路，定时控制电路发出各种控制信号控制各器件完成指令规定的操作。
    ③数据指针DPTR
    DPTR为16位寄存器。由于80C51单片机采用哈佛结构，因此，其程序存储器与地址存储器是分开的，程序存储器的地址是由程序计数器PC提供，而数据存储器的地址是由数据指针DPTR提供的，所以DPTR用于存放片外数据存储器及I/O口的地址。
    ④时钟电路
    时钟电路是计算机的心脏，它控制着计算机的工作节奏。
    ⑤复位和复位电路
    计算机在启动运行时都需要复位，复位就是使CPU和系统中的其它部件处于一个确定的初始状态，并从这个状态开始工作。
    ⑥堆栈指针SP
    堆栈指针SP用于存放栈顶单元的地址。
```

# 引脚

![QQ图片20210626105743](80C51.assets/QQ图片20210626105743.png)

``` markdown
Vss(20脚):接地

VCC（40脚）: 主电源+5V

XTAL1（19脚）:接外部晶体的一端。在片内它是振荡电路反相放大器的输入端。在采用外部时钟时，对于HMOS单片机，该端引脚必须接地；对于CHMOS单片机，此引脚作为驱动端。

XTAL2（18脚）: 接外部晶体的另一端。在片内它是一个振荡电路反相放大器的输出端，振荡电路的频率是晶体振荡频率。若需采用外部时钟电路，对于HMOS单片机，该引脚输入外部时钟脉冲；对于CHMOS单片机，此引脚应悬浮。


RST（9脚）: 单片机刚接上电源时，其内部各寄存器处于随机状态，在该脚输入24个时钟周期宽度以上的高电平将使单片机复位（RESET）

 

PSEN（29脚）: 在访问片外程序存储器时，此端输出负脉冲作为存储器读选通信号。CPU在向片外存储器取指令期间，PSEN信号在12个时钟周期中两次生效。不过，在访问片外数据存储器时，这两次有效PSEN信号不出现。PSEN端同样可驱动8个LSTTL负载。我们根据PSEN、ALE和XTAL2输出端是否有信号输出，可以判别80C51是否在工作。

 

ALE/PROG（30脚）:在访问片外程序存储器时，此端输出负脉冲作为存储器读选通信号。CPU在向片外存储器取指令期间，PSEN信号在12个时钟周期中两次生效。不过，在访问片外数据存储器时，这两次有效PSEN信号不出现。PSEN端同样可驱动8个LSTTL负载。我们根据PSEN、ALE和XTAL2输出端是否有信号输出，可以判别80C51是否在工作。

 

EA/VPP（31脚）: 当EA端输入高电平时，CPU从片内程序存储器地址0000H单元开始执行程序。当地址超出4KB时，将自动执行片外程序存储器的程序。当EA输入低电平时，CPU仅访问片外程序存储器。在对87C51EPROM编程时，此引脚用于施加编程电压VPP。

 

输入/输出引脚：

    （1）P0.0—P0.7    (39脚—32脚)

    （2）P1.0—P1.7   （1脚—8脚）

    （3）P2.0—P2.7   （26脚—21脚）

    （4）P3.0—P3.7   （10脚—17脚）
    	P3.0/RXD(串口收)
    	P3.1/TXD（串口发）
```



# 存储器

![QQ图片20210626110555](80C51.assets/QQ图片20210626110555.jpg)

``` markdown
  由于80C51单片机采用哈佛结构，所以其程序存储器和数据存储器是分开的，各有自身的寻址系统、控制信号和功能。
  程序存储器用来存放程序和表格常数；数据存储器通常用来存放程序运行所需要的给定参数和运行结果。
       从实际的物理存储介质来看，80C51有4种存储空间，它们是片内程序存储器、片外程序存储器（MOVC）、片内数据存储器（含特殊功能寄存器）和片外数据存储器(MOVX)。80C51的存储器配置情况如下图所示。
```

![QQ图片20210626105940](80C51.assets/QQ图片20210626105940.png)

``` markdwon
       从逻辑地址空间来看，80C51单片机可分为三部分，即：程序存储器、片外数据存储器、片内数据存储器。这3部分分别使用不同的地址指针，不同的访问指令。因此，下面按逻辑结构介绍80C51的存储器结构。
       （1）程序存储器
       由下图可知，程序存储器以程序计数器PC作地址指针，通过16位地址总线，可寻址的地址空间为0000H~0FFFFH共64K(216=64K)字节，其访问指令为MOVC。用于存放程序指令码与固定的数据表格等。
```

![QQ图片20210626111106](80C51.assets/QQ图片20210626111106.png)

``` markdown
 80C51单片机中内部和外部共64K字节程序存储器的地址空间是统一的。对于有内部ROM的单片机，在正常运行时，应把引脚接高电平，使程序从内部ROM开始执行。当PC值超出内部ROM的容量时，会自动转向外部程序存储器空间。
       （2）片外数据存储器
       由80C51的存储器配置图可知，片外数据存储器以DPTR作为地址指针，通过16位地址总线，可寻址的地址空间为0000H~0FFFFH共64K(216=64K)字节，其访问指令为MOVX。用于存放数据与运算结果。
       （3）片内据存储器
       片内数据存储器的地址空间从00H~FFH共256字节，其访问指令为MOV。其地址可由R0、R1寄存器提供。内部数据存储器是最灵活的地址空间，它分成物理上独立且性质上不同的2个区：00H~7FH单元组成的128字节RAM区，地址为80H~FFH的特殊功能寄存器区（简称SFR区）。
       1）RAM区（00H~7FH）
       又由80C51的存储器配置图可知，RAM区又分为3个区：工作寄存器区、位地址区与数据缓冲区。
       ①工作寄存器区（00H~1FH）
       80C51单片机的内部RAM区结构如80C51的存储器配置图所示。
       ②位地址区（20H~2FH）
       内部RAM的20H~2FH为位寻址区域，见表1所示。这16个单元的每一位都有一个位地址，位地址范围为00H~7FH。通常把各种程序状态标志、位控制变量设在位寻址区内。位寻址区的RAM单元也可以作为一般的数据缓冲区使用。

       						表1 内部RAM区的位地址映像表
```

![QQ图片20210626111229](80C51.assets/QQ图片20210626111229.png)

``` markdwon
 ③数据缓冲区
       数据缓冲区的地址空间从30H~7FH共80个字节单元，用于存放数据与运算结果，如加法运算时，存放加数、被加数及运算和。通常堆栈区也设置在该区内。有些单片机将显示缓冲区设置在该区内。
       2）特殊功能寄存器SFR（80H~FFH）
       80C51单片机内的I/O口锁存器、状态标志寄存器、定时器、串行口、数据缓冲器以及各种控制寄存器统称为特殊功能寄存器，它们离散地分布在内部RAM地址空间（80H~0FFH）内，表2列出了这些特殊功能寄存器的标识符、名称及地址。由表2-2可知累加器ACC、寄存器B、程序状态字PSW、I/O口P0~P3等均为特殊功能寄存器。
       
       
       							表2 特殊功能寄存器SFR
```

![QQ图片20210626111242](80C51.assets/QQ图片20210626111242.png)

``` markdwon
注：带“·”号的寄存器可按字节和按位寻址，其特征是直接地址能被8整除。带“*”号的寄存器是与定时器/计数器2有关的寄存器，仅在80C52系列中存在。下面以一个实例说明单片机的内部存储器。
```

![QQ图片20210626111344](80C51.assets/QQ图片20210626111344.png)

# 时序

``` markdown
震荡周期T:时序中最小的时间单位
	由外接晶体或者输入时钟决定
时钟周期（状态周期）
	晶体振荡器的真当信号经过片内时钟发生器二分频后的信号
	时钟周期是振荡周期的2倍
机器周期
	CPU执行一条指令所需要的时间的基本单位
	51单片机中的机器周期由12个振荡周期构成
	分为六个状态周期（S1-S6）
	每个状态又分为P1和P2两相时钟
指令周期
	CPU执行一条指令所需要的时间，以机器周期位单位
	
	51单片机共111条指令
	单机器周期指令：64个
	双机器周期指令：45个
	四机器周期指令:2个（乘法指令和除法指令）	
```

# 复位

``` markdown
- 在启动时需要复位，使CPU和系统的各个部件处于一种初始状态
- 复位信号从单片机的RST引脚输入，高电平有效，维持至少两个机器周期
- 上电自动复位
- 按键手动复位
```

# 并行I/O口

![QQ图片20210626111834](80C51.assets/QQ图片20210626111834.jpg)

![QQ图片20210626115604](80C51.assets/QQ图片20210626115604.jpg)

``` markdwon
80C51单片机含有4 个8位并行I/O口P0、P1、P2和P3。
每个口有8个引脚，如图2-1所示，共有32个I/O引脚，每一个并行I/O口都能用作输入或输出。
每一条IO引脚都能独立地用作输入或输出，做输出时数据可以锁存，做输入时数据可以缓冲

        各口的第一、第二功能如下：
               I/O口     引脚       第一功能           第二功能
               P0口   P0.0~P0.7    输入与输出       分时的传送地址低8位与数据线
               P1口   P1.0~P0.7    输入与输出       无第二功能
               P2口   P2.0~P2.7    输入与输出       传送地址的高8位
               P3口   P3.0~P3.7    输入与输出       P3.0——RXD：串行口输入端
               P3.1——TXD：串行口输出端
               P3.2——INT0：外部中断0中断请求输入端
               P3.3——INT1：外部中断1中断请求输入端
               P3.4——T0：定时器/计数器0外部输入端
               P3.5——T1：定时器/计数器1外部输入端
               P3.6——WR：外部数据存储器写选通信号
               P3.7——RD：外部数据存储器读选通信号
               
               
       四个通道口都有一种特殊的线路结构，每个口都包含一个锁存器，即特殊功能寄存器P0~P3，一个输出驱动器和两个（P3口有三个）三态缓冲器。这种结构在数据输出时，可以锁存，即在重新输出新的数据之前，口上的数据一直保持不变。但对于输入信号是不锁存的，所以外设欲输入的数据必须保持到取数指令执行（把数据读取后）为止。
       
       
       
       下面分别叙述各个端口的结构、功能和使用方法。
       -------------------------------------------------------------------------------------------
（1）P0口的组成与功能————————三态双向口

       1）位结构
       在访问外部存储器时，P0口是一个真正的双向数据总线口，并分时送出地址的低8位。
       它包含两个输入缓冲器、一个输出锁存器以及输出驱动电路、输出控制电路。
       输出驱动电路由两只场效应管V1和V2组成，其工作状态受输出控制电路的控制。输出控制电路包括与门、反相器和多路模拟开关MUX。
       P0口既能用作通用I/O口（需要上拉电阻），又能用作地址/数据总线（不需要上拉电阻）。
       
       2）作为通用I/O口
       P0口作为通用I/O口使用时，CPU令控制信号为低电平。这时多路开关MUX接通B端即输出锁存器的 端，同时使与门输出低电平，场效应管V1截止，因而输出级为开漏输出电路。

           ①作为输出口
           当用P0口输出数据时，写信号加在锁存器的时钟端CL上，此时与内部总线相连的D端其数据经反相后出现的 端上，再经V2管反相，于是在P0口引脚上出现的数据正好是内部总线上的数据。由于输出级为开漏电路，所以用作输出口时应外接上拉电阻。
           ②作为输入口
           当P0口用于输入数据时，要使用端口中的两个三态输入缓冲器之一。这时有两种工作方式：读引脚和读锁存器。
           当CPU执行一般的端口输入指令时，“读引脚”信号使图2-4中下面一个缓冲器开通，于是端口引脚上的数据经过缓冲器输入到内部总线上。
           当CPU执行“读一修改一写”一类指令时，“读锁存器”信号使图2-4上面一个缓冲器开通，锁存器Ｑ端的数据经缓冲器输入内部数据总线。
           在P0口作为输入口使用时，必须首先向端口锁存器写入“1”。这是因为当进行读引脚操作时，如果V2是导通的，那么不论引脚上的输入状态如何，都会变为低电平。为了正确读入引脚上的逻辑电平，先要向锁存器写1，使其 端为0，V2截止。该引脚成为高阻抗的输入端。
           
       3）作为地址/数据总线
       P0口还能作为地址总线低8位或数据总线，供系统扩展时使用。这时控制信号为高电平，多路开关MUX接通A端。有两种工作情况：一种是总线输出，另一种是外部数据输入。作为总线输出时，从“地址/数据”端输入的地址或数据信号通过与门驱动V2，同时通过非门驱动V2，结果在引脚上得到地址或数据输出信号。
       作为数据总线输入数据时，从引脚上输入的外部数据经过读引脚缓冲器进入内部数据总线。对于80C51、87C51单片机，P0口能作为I/O口或地址/数据总线使用。对于80C31单片机，P0口只能用作地址/数据总线。
       综上所述，P0口既可以作为地址/数据总线口，这时它是真正的双向口，也可作通用的I/O口，但只是一个准双向口。准双向口的特点是：复位时，口锁存器均置“1”，8根引脚可当一般输入线使用，而在某引脚由原输出状态变成输入状态时，则应先写入“1”，以免错读引脚上的信息。一般情况下，P0口已当作地址/数据总线口使用时，就不能再作通用I/O口使用。


       -------------------------------------------------------------------------------------------
（2）P1口组成与功能————————准双向口

       P1口只用作通用I/O口，其一位结构图如图所示。与P0口相比，P1口的位结构图中少了地址/数据的传送电路和多路开关，上面一只MOS管改为上拉电阻。
       P1口作为一般I/O的功能和使用方法与P0口相似。当输入数据时，应先向端口写“1”。它也有读引脚和读锁存器两种方式。所不同的是当输出数据时，由于内部有了上拉电阻，所以不需要再外接上拉电阻。
       P1口作为输入口使用时，有两种工作方式：读端口   读引脚
       	读端口:实际上并不从外部读入数据，只是把端口锁存器中的内容读入到内部总线，经过某种运算和变换后，再写回端口锁存器；
       	读引脚:真正地把外部的输入信号读入到内部总线。
       	
       
       
       -------------------------------------------------------------------------------------------      
（3）P2口的组成与功能————————准双向口

		当系统中接有外部存储器时，P2口可用于输出高8位地址，若当作通用I/O口用，P2口则是一个准双向口。因此说P2口能用作通用I/O口或地址总线，其一位的结构如图所示。
       ①作为通用I/O口
       当控制信号为低电平时，多路开关接到B端，P2口作为通用I/O口使用，其功能和使用方法与P1口相同。
       ②作为地址总线
       当控制端输出高电平时，多路开关接到A端，地址信号经反相器、V从引脚输出。这时P2口输出地址总线高8位，供系统扩展使用。
       对80C51、87C51单片机，P2口能作为I/O口或地址总线作用。对于80C31单片机，P2口只能用作地址总线。
      
     -------------------------------------------------------------------------------------------     
（4）P3口组成与功能———————多功能口

	P3口能作通用I/O口，同时每一引脚还有第二功能。P3口的一位结构如图2-7所示。
    作为通用I/O口：当“第二功能输出”端为高电平时，P3口用作通用I/O口。这时与非门对于输入端Q来说相当于非门，位结构与P2口完全相同，因此P3口用作通用I/O口时的功能和使用方法与P2口、P1口相同。
    用作第二功能： 当P3口的某一位作为第二功能输出使用时，应将该位的锁存器置“1”，使与非门的输出状态只受“第二功能输出”端的控制。“第二功能输出”端的状态经与非门和驱动管V输出到该位引脚上。
    当P3口的某一位作为第二功能输入使用时，该位的锁存器和“第二功能输出”端都应为“1”，这样，该位引脚上的输入信号经缓冲器送入“第二功能输入”端。
    
    
    
    
    
    
    
    至此，可以对组成一般单片机应用系统时各个并行口的分工小结如下：
    P0口：分时的用作地址低8位与数据线，低8位地址由PC低8位或DPL提供。
    P1口：按位可编址的输入输出口。
    P2口：地址线的高8位，高8位地址由PC高8位或DPH提供。
    P3口：双功能口，若不用第二功能，可作为一般的I/O口。
```



# 定时器/计数器

``` markdown
- 80C51 单片机内部有两个可编程定时器/计数器，T0和T1
- 他们的工作方式指令对相应的特殊功能寄存器编程来设定，设置后用作定时器或计数器
- 定时器/计数器的硬件组成就是：双字节加法计数器TH和TL
- 作定时器使用时，计数器脉冲由单片机内部振荡器提供,计数频率为震荡频率的12分之一，即每个机器周期加1
- 作计数器使用时，计数脉冲由P3口的P3.4（或P3.5）即T0(或T1)引脚引入，外部脉冲的下降沿触发计数，计数器在每个机器周期的S5P2期间采样外部脉冲。
		若一个周期的采样值为1，下一个周期的采样值为0，则计数器加1，故识别一个从0到1的跳变需要两个机器周期
```

``` markdown
工作原理：
加1计数器输入的计数脉冲有两个来源，一个是由系统的时钟振荡器输出脉冲经12分频后送来，一个是T0或T1引脚输入的外部脉冲源。每来一个脉冲计数器加1，当加到计数器全为1时，再输入一个脉冲就使计数器回零，计数器的溢出使TCON中的TF0或TF1置1，向CPU发出中断请求（定时/计数器中断允许时）。如果定时/计数器工作于定时模式，则表示定时时间已到，如果工作于计数模式，则表示计数值已满。

可见，由溢出时计数器的值减去计数初值才是加1计数器的计数值。

设置为定时器模式时，加1计数器是对内部机器周期计数（1个机器周期等于12个振荡周期，即技术频率为晶振频率的1/12）。计数值N乘以机器周期Tcy就是定时时间t。

例：假设计数50个数，那么定时时间为：   （定时时间（μs）=计数数X1/(晶振频率)X12）。

16位寄存器能够计数的最大时间为65536μs。

设置为计数模式时，外部事件计数脉冲由T0或T1引脚输入到计数器。在每个机器周期的S5P2期间采样T0、T1引脚电平。当某周期采样到一高电平输入，而下一周期有采样到一低电平时，计数器加1，更新的计数值在下一机器周期得S3P1期间装入计数器。由于检测一个从1到0下降沿需要2个机器周期，因此要求被采样的电平至少要维持一个机器周期。当晶振频率为12MHz时，最高计数频率不超过1/2MHz，即计数脉冲的周期要大于2μs。
```

TMOD：定时器/计数器的工作方式

TCON：定时器/计数器的启动运行

80C51单片机定时/计数器的工作由两个特殊功能寄存器控制。**TMOD用于设置其工作方式；TCON用于控制其启动和中断申请**。

## 方式控制寄存器 TMOD

地址：89H

**工作方式寄存器TMOD用于设置定时/计数器的工作方式，**低四位用于T0，高四位用于T1。其格式如下：

![QQ图片20210627094607](80C51.assets/QQ图片20210627094607.png)

``` markdown
GATE：门控位。GATA=0时，只要用软件使TCON中的TR0或TR1为1，就可以启动定时/计数器工作；GATA=1时，要用软件使TR0或TR1为1，同时外部中断引脚也为高电平时，才能启动定时/计数器工作。

C//T：定时/计数模式选择位。C/=0时为定时模式；C/=1时为计数模式。

M1M0：工作方式设置位。定时/计数器有四种工作方式，由M1M0进行设置。
```

![QQ图片20210627094610](80C51.assets/QQ图片20210627094610.png)

## 运行控制寄存器 TCON

TCON的低4位用于控制外部中断。TCON的高4位用于控制定时/计数器的**启动和中断申请**。其格式如下：

![QQ图片20210627094643](80C51.assets/QQ图片20210627094643.png)

``` markdown
TF1（TCON.7）：T1溢出中断请求标志位。T1计数溢出时由硬件自动置TF1为1。CPU响应中断后TF1由硬件自动清0.T1工作时，CPU可随时查询TF1的状态。所以，TF1可用作查询测试的标志。TF1也可以用软件置1或清零，同硬件置1或清0的效果一样。

TR1（TCON.6）：T1运行控制位。TR置1时，T1开始工作；TR1置0时，T1停止工作。TR1由软件置1或清零。所以，软件可控制定时/计数器的启动与停止。

TF0（TCON.5）：T0溢出中断请求标志位，其功能与TF1类同。

TR0（TCON.4）：T0运行控制位，其功能与TR1类同。
```

![QQ图片20210627094923](80C51.assets/QQ图片20210627094923.png)

### 方式0

![QQ图片20210627095053](80C51.assets/QQ图片20210627095053.png)

![QQ图片20210627095059](80C51.assets/QQ图片20210627095059.png)

### 方式1

![QQ图片20210627095112](80C51.assets/QQ图片20210627095112.png)

### 方式2

![QQ图片20210627095120](80C51.assets/QQ图片20210627095120.png)

### 方式3

![QQ图片20210627095127](80C51.assets/QQ图片20210627095127.png)

# 中断

## 中断的概念

``` markdown
- 单片机与外设交换信息可采用查询方式和中断方式
- 中断就是CPU暂时终止当前正在执行的程序而转去执行中断服务子程序，所有中断的方式CPU效率高！


- 中断类型
	- 屏蔽中断
		又名：直接中断
		通过指令使中断系统与外界隔开，使外接发来的中断请求不起作用，不引起中断。
	- 非屏蔽中断
		计算机一定要处理的中断方式，不能用软件来加以屏蔽
		一般用与程序中掉电等紧急情况
	- 软件中断
		一种用指令系统中专门的中断指令来实现的一种中断，一般用与程序中断点的设置，以便于程序的调试！
		
中断源:
	引起中断的原因，或是能发出中断申请的来源
	
中断系统的任务：
	对于中断申请开放或屏蔽（开中断和关中断）
		只有在开中断的情况下，才有可能接受中断源的申请
	中断的排队
		中断优先级问题
	中断的响应
		单片机在响应了中断的申请后，应使CPU从主程序转去执行中断服务子程序；
		同时要把断点地址送人堆栈进行保护，以便在执行完中断服务子程序后能返回到原来的断点继续执行主程序。
		中断系统还要能够确定各个被响应中断源的中断服务子程序的入口
	中断的撤销
		在响应中断请求之后，返回主程序之前，中断申请应该撤销；
		否则就等于中断申请仍然存在，这将会影响其他中断申请的响应；
        80C51只能对一部分中断申请在响应后自动撤销
        
```



## 中断申请与控制

``` markdown
5个中断源

- 两个外部中断
  - 两个外部中断源分别从/INT0（P3.2）和/INT1（P3.3）引脚输入
  - 外部中断请求信号：
  - 电平输入方式
    - /INT0（P3.2）和/INT1（P3.3）引脚检测到低电平为有效的中断申请
  - 负边沿输入方式
    - /INT0（P3.2）和/INT1（P3.3）引脚检测到从1到0的负脉冲跳变
- 两个定时器/计数器中断
  - 内部中断
  - 当T0或T1溢出（全1变成全0）时发出中断申请
- 一个串行口中断
  - 内部中断
  - 在串行口，每接受或发送完一组数据后自动发出的中断申请
```



### TCON寄存区

- 地址88H
- 其中各位都可以位寻址，位地址88H-8FH；
- 定时器/计数器溢出中断和外部中断的申请标志，在CPU响应中断之后会自动撤除

![QQ图片20210626140324](80C51.assets/QQ图片20210626140324.jpg)

### SCON寄存区

- 地址98H
- 位寻址：98H-9FH
- 串行口的中断申请标志是由TI和RI相或以后产生的，并且串行口中断申请在得到CPU响应之后不会自动撤除

![QQ图片20210626140340](80C51.assets/QQ图片20210626140340.jpg)

### IE 中断允许寄存区

- 地址A8H
- 位寻址:A8H-AFH
- 80C51在复位时，IE各位的状态都是0，所以CPU处于关中断的状态

![QQ图片20210626140355](80C51.assets/QQ图片20210626140355.jpg)

### IP 中断优先级寄存器

- 地址B8H
- 位寻址：B8H-BCH
- IP寄存器的某一位为1则相应的中断源为高优先级
- IP寄存器的某一位为0则相应的中断源为低优先级

![QQ图片20210626140414](80C51.assets/QQ图片20210626140414.jpg)

![QQ图片20210626140431](80C51.assets/QQ图片20210626140431.jpg)

## 中断响应

![QQ图片20210627091716](80C51.assets/QQ图片20210627091716.jpg)

## 中断响应的条件

``` markdown
①、中断源有中断请求；
②、此中断源的中断允许为位1；
③、CPU开中断（即EA=1）。
```

以外部中断0为例：

​       主程序中需要的代码：

``` C
EA=1；//打开总中断开关
EX0=1；//开外部中断0
IT0=0/1；//设置外部中断的触发方式
```



​        中断服务函数： 

``` C
//void 函数名（）interrupt(中断服务子程序) 0(优先级)
void int0 () interrupt 0 

{
　　do anything that you want

}
```

# 串口通信

## 波特率

![QQ图片20210627095510](80C51.assets/QQ图片20210627095510.png)
## 同步与异步

![QQ图片20210627095754](80C51.assets/QQ图片20210627095754.png)

![QQ图片20210627095758](80C51.assets/QQ图片20210627095758.png)

![QQ图片20210627095800](80C51.assets/QQ图片20210627095800.png)

![QQ图片20210627095802](80C51.assets/QQ图片20210627095802.png)

![QQ图片20210627095808](80C51.assets/QQ图片20210627095808.png)
## 串口结构

![QQ图片20210627095919](80C51.assets/QQ图片20210627095919.png)



## 串行口控制寄存器 SCON



![QQ图片20210627100401](80C51.assets/QQ图片20210627100401.png)

![QQ图片20210627100403](80C51.assets/QQ图片20210627100403.png)

![QQ图片20210627100406](80C51.assets/QQ图片20210627100406.png)

![QQ图片20210627100408](80C51.assets/QQ图片20210627100408.png)

## 特殊功能寄存器 PCON

``` markdown
只有D7位与串口工作有关
D7（SMOD）=1 串行口传送的波特率加倍
```



## 串行口的四种工作方式

![QQ图片20210627100702](80C51.assets/QQ图片20210627100702.png)

![QQ图片20210627100705](80C51.assets/QQ图片20210627100705.png)

![QQ图片20210627100707](80C51.assets/QQ图片20210627100707.png)

![QQ图片20210627100709](80C51.assets/QQ图片20210627100709.png)



# DA



# AD

